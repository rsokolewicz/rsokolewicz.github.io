<!doctype html><html lang=en><head><title>Debugging gitlab pipeline docker containers :: Roberts blog</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Sometimes a pipeline that is running on GitLab has unexpected behavior, but how do we access the docker image so that we can debug locally?"><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://www.robert-sokolewicz.nl/posts/13_gitlab_docker/><link rel=stylesheet href=https://www.robert-sokolewicz.nl/assets/style.css><link rel=stylesheet href=https://www.robert-sokolewicz.nl/assets/css/style.css><link rel=stylesheet href=https://www.robert-sokolewicz.nl/assets/css/hugo-cite.css><link rel=apple-touch-icon href=https://www.robert-sokolewicz.nl/img/apple-touch-icon-192x192.png><link rel="shortcut icon" href=https://www.robert-sokolewicz.nl/img/favicon/orange.png><meta name=twitter:card content="summary"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="Debugging gitlab pipeline docker containers"><meta property="og:description" content="Sometimes a pipeline that is running on GitLab has unexpected behavior, but how do we access the docker image so that we can debug locally?"><meta property="og:url" content="https://www.robert-sokolewicz.nl/posts/13_gitlab_docker/"><meta property="og:site_name" content="Roberts blog"><meta property="og:image" content="https://www.robert-sokolewicz.nl/img/favicon/orange.png"><meta property="og:image:width" content="2048"><meta property="og:image:height" content="1024"><meta property="article:published_time" content="2023-08-24 00:00:00 +0000 UTC"><script>MathJax={tex:{inlineMath:[['$','$'],['\\(','\\)']],displayMath:[['$$','$$'],['\\[','\\]']],macros:{bb:["{\\boldsymbol{#1}}",1],tr:"{\\DeclareMathOperator{\\tr}{Tr}}",im:"{\\DeclareMathOperator{\\im}{Im}}",re:"{\\DeclareMathOperator{\\re}{Re}}",},processEscapes:true,processEnvironments:true,tags:"ams"},options:{skipHtmlTags:['script','noscript','style','textarea','pre']}};window.addEventListener('load',(event)=>{document.querySelectorAll("mjx-container").forEach(function(x){x.parentElement.classList+='has-jax'})});</script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script type=text/javascript id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><script type=text/x-mathjax-config>
    MathJax.Hub.Queue(function() {
        // Fix <code> tags after MathJax finishes running. This is a
        // hack to overcome a shortcoming of Markdown. Discussion at
        // https://github.com/mojombo/jekyll/issues/199
        var all = MathJax.Hub.getAllJax(), i;
        for(i = 0; i &lt; all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
    </script></head><body class=orange><div class="container center headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>Home</div></a></div><div class=menu-trigger>menu</div></div><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/about>About</a></li><li><a href=/books>Book Reviews</a></li><li><a href=/cv>CV</a></li><li><a href=/physics>Physics</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/about>About</a></li><li><a href=/books>Book Reviews</a></li><li><a href=/cv>CV</a></li><li><a href=/physics>Physics</a></li></ul></nav></header><div class=content><div class=post><h1 class=post-title><a href=https://www.robert-sokolewicz.nl/posts/13_gitlab_docker/>Debugging gitlab pipeline docker containers</a></h1><div class=post-meta><span class=post-date>2023-08-24</span>
<span class=post-author>:: Robert</span></div><div class=post-content><div><h2 id=docker-images-and-containers>docker images and containers<a href=#docker-images-and-containers class=hanchor arialabel=Anchor>&#8983;</a></h2><p>Sometimes a pipeline that is running on GitLab has unexpected behavior, for example when a build is different from when you execute a build locally on your laptop. For debugging it is very useful to have the same environment, and sometimes just running a fresh conda environment and installing all the requirements is not enough.</p><p>A container is merely an instance that is running a docker image, and so all we need to do is find the Docker image reference in the GitLab registry and we&rsquo;re good to go.</p><h2 id=looking-up-the-docker-image-reference>looking up the docker image reference<a href=#looking-up-the-docker-image-reference class=hanchor arialabel=Anchor>&#8983;</a></h2><ol><li>in your GitLab repository, navigate in the menu on the left, to Deploy > Container Registry<figure class=center><img src=images/image.png></figure></li><li>search for the branch name</li><li>click the copy-to-clipboard button</li></ol><figure class=center><img src=images/image-2.png></figure><p>Sometimes you have a pipeline that creates another docker image, in which case you can often find the image name in the log of your pipeline. In each case, the reference will look similar to:</p><pre><code>registry.gitlab.com/&lt;repo&gt;/&lt;pipeline name&gt;/python3.8@sha256:ce3f78d603803740615069e7680715d3707998671db4ee32fbec3e98f4dc2d53
</code></pre><h2 id=executing-the-docker-container>executing the docker container<a href=#executing-the-docker-container class=hanchor arialabel=Anchor>&#8983;</a></h2><p>The registry is not publicly available by default, so before creating a new docker container, you&rsquo;ll have to log into the registry first:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>docker login registry.gitlab.com
</code></pre></div><p>which will ask for your GitLab username and password. If you have two-factor authentication enabled, you&rsquo;ll have to create an authentication token in the browser and use that as your password instead.</p><p>Now that we are logged in, you can create a new container that will run this image for you with the command:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>docker run -it --name my-container &lt;image-path&gt; /bin/bash
</code></pre></div><p>here:</p><ul><li>the <code>-it</code> flag makes sure that the container runs in an interactive mode</li><li><code>&lt;image-path></code> should be replaced with the image path that we just copied</li><li>and <code>/bin/bash</code> is the command that will be executed first. This is often optional, but sometimes there&rsquo;s a default <code>CMD</code> specified in the image that we would like to override while debugging.</li></ul><h2 id=troubleshooting>troubleshooting<a href=#troubleshooting class=hanchor arialabel=Anchor>&#8983;</a></h2><h3 id=cannot-connect-to-docker-daemon>cannot connect to Docker Daemon<a href=#cannot-connect-to-docker-daemon class=hanchor arialabel=Anchor>&#8983;</a></h3><p>The first time I tried this, I ran into the following problem. Running <code>docker run</code> would give me back</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>docker: Cannot connect to the Docker daemon at unix:///var/run/docker.sock
</code></pre></div><p>Many solutions can be found on Stackoverflow, but for me, the problem was that I was running Docker inside WSL, but I had installed Docker both in my Ubuntu partition and on Windows. The solution was to uninstall both, install the Windows version and in the settings, you specify that you want to run docker inside WSL.</p><h3 id=permission-denied-while-trying-to-connect>permission denied while trying to connect<a href=#permission-denied-while-trying-to-connect class=hanchor arialabel=Anchor>&#8983;</a></h3><p>then I got this problem</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>docker: Got permission denied <span style=color:#66d9ef>while</span> trying to connect to the Docker daemon socket at unix:///var/run/docker.sock: Post http://%2Fvar%2Frun%2Fdocker.sock/v1.35/containers/create: dial unix /var/run/docker.sock: connect: permission denied. See <span style=color:#e6db74>&#39;docker run --help&#39;</span>.
</code></pre></div><p>when using Unix (WSL/Linux/macOS) you have to run docker either as a super user (<code>sudo docker run</code>) or you have to add yourself to the <code>docker</code> group:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>sudo groupadd docker
sudo usermod -aG docker $USER
newgrp docker
</code></pre></div><p>The first line creates the <code>docker</code> group (if it doesn&rsquo;t yet exist), the second line adds you to that group (<code>-aG</code> stands for append and group), and the third logs you into that group. The third option is just so that you don&rsquo;t have to reload the shell. You could just as well reopen your terminal.</p></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=https://www.robert-sokolewicz.nl/posts/14_unit_testing/><span class=button__icon>←</span>
<span class=button__text>Unit testing - Classical vs. London Approaches</span></a></span>
<span class="button next"><a href=https://www.robert-sokolewicz.nl/posts/12_gitbeard/><span class=button__text>Git ahoy! A Pirate's Tale of Version Control</span>
<span class=button__icon>→</span></a></span></div></div></div></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2023 Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script src=https://www.robert-sokolewicz.nl/assets/main.js></script><script src=https://www.robert-sokolewicz.nl/assets/prism.js></script></div></body></html>